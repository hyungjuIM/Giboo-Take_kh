<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="memberMapper">

    <!-- 결과 매핑 -->
    <resultMap type="member" id="member_rm">
        <id property="memberNo" column="MEMBER_NO"/>
        <result property="memberId" column="MEMBER_ID"/>
        <result property="memberPw" column="MEMBER_PW"/>
        <result property="memberEmail" column="MEMBER_EMAIL"/>
        <result property="memberName" column="MEMBER_NAME"/>
        <result property="memberNick" column="MEMBER_NICK"/>
        <result property="memberTel" column="MEMBER_TEL"/>
        <result property="memberAddr" column="MEMBER_ADDR"/>
        <result property="enrollDt" column="ENROLL_DT"/>
        <result property="secessionFlag" column="SECESSION_FL"/>
        <result property="profileImg" column="PROFILE_IMG"/>
        <result property="memberType" column="MEMBER_TYPE"/>
        <result property="rateNo" column="RATE_NO"/>
        <result property="pointNo" column="POINT_NO"/>
        <result property="pointPrice" column="POINT_PRICE"/>
    </resultMap>

    <resultMap type="manager" id="manager_rm">
    	<id property="managerNo" column="MANAGER_NO"/>
    	<result property="managerId" column="MANAGER_ID"/>
    	<result property="managerPw" column="MANAGER_PW"/>
    	<result property="managerEmail" column="MANAGER_EMAIL"/>
    	<result property="managerName" column="MANAGER_NAME"/>
    	<result property="managerNickname" column="MANAGER_NICKNAME"/>
    	<result property="managerTel" column="MANAGER_TEL"/>
    	<result property="managerPermission" column="MANAGER_PERMISSION"/>
    	<result property="managerProfileImg" column="MANAGER_PROFILE_IMG"/>
    	<result property="managerSignUpStatus" column="MANAGER_SIGNUP_STATUS"/>
    	<result property="managerSignUpReason" column="MANAGER_SIGNUP_REASON"/>
    </resultMap>
    
    <!--  이메일 인증 -->
	<resultMap type="emailCertification" id="emailcertification_rm">
		<id property="email" column="EMAIL"/>
		<result property="cNumber" column="CERTIFICATION_NO" />
		<result property="issueDate" column="ISSUE_DT"/>
	</resultMap>

    <!-- 로그인 쿼리 -->
    <select id="login" parameterType="member" resultMap="member_rm">
        SELECT MEMBER_NO, MEMBER_ID, MEMBER_PW, MEMBER_EMAIL, MEMBER_NAME, MEMBER_NICK,
        MEMBER_TEL, MEMBER_ADDR,
        TO_CHAR(ENROLL_DT,'YYYY-MM-DD HH24:MI:SS') AS ENROLL_DT,
        PROFILE_IMG,MEMBER_TYPE,RATE_NO,POINT_NO,POINT_PRICE
        FROM MEMBER
        WHERE MEMBER_ID = #{memberId}
        AND SECESSION_FL = 'N'
    </select>
	
	<!-- 매니저 로그인 -->
	<select id="managerLogin" parameterType="manager" resultMap="manager_rm">
		SELECT MANAGER_NO, MANAGER_ID, MANAGER_PW, MANAGER_EMAIL,
		MANAGER_NAME, MANAGER_NICKNAME, MANAGER_TEL,MANAGER_PERMISSION,
		MANAGER_PROFILE_IMG,MANAGER_SIGNUP_REASON
		FROM MANAGER
		WHERE MANAGER_ID = #{memberId}
		AND MANAGER_SIGNUP_STATUS = 'N'
	</select>
	
	<!-- 이메일 인증 -->
	<!-- <update id="updateCertification">
		UPDATE EMAIL_CERTIFICATION SET
		CERTIFICATION_NO = #{cNumber},
		ISSUE_DT = SYSDATE
		WHERE EMAIL = #{email}
	</update> -->

	<insert id="insertCertification">
        INSERT INTO EMAIL_CERTIFICATION (EMAIL, CERTIFICATION_NO, ISSUE_DT) VALUES(#{memberEmail}, #{cNumber}, SYSDATE)
    </insert>

	<select id="checkNumber" resultType="_int">
      SELECT
        CASE
          WHEN EXISTS (
            SELECT '1' FROM EMAIL_CERTIFICATION
            WHERE EMAIL = #{memberEmail}
            AND CERTIFICATION_NO = #{cNumber}
          ) THEN
            CASE
              WHEN EXISTS (
                SELECT '1' FROM EMAIL_CERTIFICATION
                WHERE EMAIL = #{memberEmail}
                AND ISSUE_DT + (INTERVAL '5' MINUTE) >= SYSDATE
              ) THEN '1'
              ELSE '2'
            END
          ELSE '3'
        END
      FROM DUAL
    </select>

	<select id="emailDupCheck" parameterType="String" resultType="_int">
		SELECT COUNT(*) FROM MEMBER
		WHERE MEMBER_EMAIL = #{memberEmail}
		AND SECESSION_FL = 'N'
	</select>
	
	<!-- 닉네임 중복 검사 -->
<select id="nicknameDupCheck" parameterType="String" resultType="_int">
    SELECT COUNT(*) FROM MEMBER
    WHERE MEMBER_NICK = #{memberNick}
    AND SECESSION_FL = 'N'
</select>

<!-- 아이디 중복 검사 -->
<select id="IdDupCheck" parameterType="String" resultType="_int">
    SELECT COUNT(*) FROM MEMBER
    WHERE MEMBER_ID = #{memberId}
    AND SECESSION_FL = 'N'
</select>

<!-- 회원가입 -->
<insert id="signUp" parameterType="member">

	INSERT INTO MEMBER VALUES(
	SEQ_MEMBER_NO.NEXTVAL,
	#{memberId},
	#{memberPw},
	#{memberEmail},
	#{memberName},
	#{memberNick},
	#{memberTel},
	#{memberAddr},
	DEFAULT, DEFAULT, NULL, 'Y', NULL, NULL,NULL
	)
</insert>

<!-- 회원 정보 수정 -->
	<update id="memberChange" parameterType="member">
		UPDATE MEMBER SET
		MEMBER_NAME = #{updateName},
		MEMBER_NICK = #{updateNickname},
		MEMBER_TEL = #{updateTel},
		MEMBER_ADDR = #{memberAddress}
		WHERE MEMBER_NO = ${memberNo}  
	</update>
	
	<!-- 비밀번호 변경 -->
	<update id="changePw" parameterType="member">
		UPDATE MEMBER SET
		MEMBER_PW = #{newPw}
		WHERE MEMBER_NO = #{memberNo}
	</update>
	
	<!-- 프로필 이미지 수정 -->
	<update id="changeProfile" parameterType="member">
		UPDATE MEMBER SET
		PROFILE_IMG = #{profileImg}
		WHERE MEMBER_NO = #{memberNo}
	</update>

	<!-- 회원 탈퇴 -->
	<update id="withdrawal">
		UPDATE MEMBER SET
		SECESSION_FL = 'Y'
		WHERE MEMBER_NO = #{memberNo}
	</update>


</mapper>
 